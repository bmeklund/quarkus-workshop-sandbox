<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Securing Quarkus APIs :: Quarkus Workshop Guides</title>
    <link rel="canonical" href="https://bmeklund.github.io/quarkus-workshop-sandbox/rhs-quarkus-guides/security.html">
    <link rel="prev" href="tracing.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://bmeklund.github.io/quarkus-workshop-sandbox">Quarkus Workshop Guides</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhs-quarkus-guides" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Quarkus Workshop Guides</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intro.html">Lab Instructions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Module One</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="basics.html">Getting Started with Quarkus</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cdi.html">Dependency Injection</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing.html">Testing Quarkus Apps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="debugging.html">Debugging Quarkus Apps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="native.html">Building Native Quarkus Apps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cloudnative.html">Developing Cloud Native with Quarkus</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deploy.html">Deploying to the cloud</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Module Two</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="extensions.html">Using Quarkus extensions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="panache.html">Hibernate ORM with Panache</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="openapi.html">Documenting and Testing APIs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="messaging.html">Event-driven Messaging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="kafka.html">Streaming Data with Quarkus and Kafka</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="monitoring.html">Monitoring with Prometheus and Grafana</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tracing.html">Tracing Quarkus Apps with Jaeger and MicroProfile Tracing</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="security.html">Securing Quarkus APIs</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Quarkus Workshop Guides</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Quarkus Workshop Guides</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Quarkus Workshop Guides</a></li>
    <li>Module Two</li>
    <li><a href="security.html">Securing Quarkus APIs</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/bmeklund/quarkus-workshop-sandbox/edit/master/documentation/modules/ROOT/pages/security.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Securing Quarkus APIs</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Bearer Token Authorization is the process of authorizing HTTP requests based on the existence and validity of a bearer token representing a subject and her access context, where the token provides valuable information to determine the subject of the call as well whether or not a HTTP resource can be accessed. This is commonly used in OAuth-based identity and access management systems like <a href="https://keycloak.org" target="_blank" rel="noopener">Keycloak</a>, a popular open source project. In this exercise we&#8217;ll show you how to use <a href="https://github.com/eclipse/microprofile-jwt-auth/releases/download/1.1.1/microprofile-jwt-auth-spec.pdf" target="_blank" rel="noopener">Microprofile JSON Web Token (JWT) RBAC</a>, <a href="https://access.redhat.com/documentation/en-us/red_hat_build_of_keycloak" target="_blank" rel="noopener">Red Hat build of Keycloak</a> and <a href="https://en.wikipedia.org/wiki/OAuth" target="_blank" rel="noopener">OAuth</a> to secure your Quarkus applications.</p>
</div>
<div class="paragraph">
<p>Red Hat build of Keycloak is well suited for securing web-based and other modern applications, mobile apps, APIs and services, by leveraging popular standards and security protocols such as OpenID Connect, OAuth and SAML with the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Seamless User Experience, Login, Logout, Self-registration, User Account Management</p>
</li>
<li>
<p>Strong Authentication, MFA, Passwordless authentication</p>
</li>
<li>
<p>Single-Sign-On, Login once to multiple applications</p>
</li>
<li>
<p>Identity Federation, connect to existing LDAP, Active Directory servers, or users in other stores</p>
</li>
<li>
<p>Identity Brokering, authenticating with external OpenID Connect or SAML Identity Providers</p>
</li>
<li>
<p>Social Login, enable login with Google, GitHub, Facebook, Twitter/X, and other social networks</p>
</li>
<li>
<p>Role-based access control, fine-grained Authorization services</p>
</li>
<li>
<p>FIPS Compliance (FIPS 140-2)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Find more information <a href="https://developers.redhat.com/articles/2023/11/15/whats-new-red-hat-build-keycloak-version-22" target="_blank" rel="noopener">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_keycloak_instance"><a class="anchor" href="#_deploy_keycloak_instance"></a>Deploy Keycloak instance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can install Keycloak in many ways, including just downloading and extracting a zip file, downloading the source and building it, or manually constructing a container and deploying it. Kubernetes Operators make both the installation and management of Keycloak (and many other software packages) much easier, and we have installed the Keycloak operator for you to use.</p>
</div>
<div class="sect2">
<h3 id="_deploy_keycloak_database"><a class="anchor" href="#_deploy_keycloak_database"></a>Deploy Keycloak Database</h3>
<div class="paragraph">
<p>Keycloak needs a database to store its data. We&#8217;ll use Postgres. Back on the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-project?view=graph[OpenShift web console^], click the Add icon once again, type <code>postgres ephemeral</code> into the search box, locate the <code>Postgres (Ephemeral)</code> template, click on it, and click <strong>Instantiate Template</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/postgres-create-kc.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p>On the next screen, override the following values (leaving the rest as their defaults):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Database Service Name</strong>: <code>keycloak-postgresql</code></p>
</li>
<li>
<p><strong>PostgreSQL Database Name</strong>: <code>keycloak</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Leave the rest as-is, including the username and password, which will be auto-generated for you and you&#8217;ll refer to them later. Finally, click <strong>Create</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/postgres-create2-kc.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p>You should see a postgres database begin spinning up:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/postgres-create3-kc.png" alt="kc" width="800">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_self_signed_certificate"><a class="anchor" href="#_create_self_signed_certificate"></a>Create self-signed certificate</h3>
<div class="paragraph">
<p>Let&#8217;s make the postgresql database icon show its proper logo by running the following <code>oc</code> command in the terminal:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n {{ USER_ID }}-project label dc keycloak-postgresql "app.openshift.io/runtime=postgresql" --overwrite</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keycloak needs a certificate pair to use for TLS communication. We will use OpenSSL to generate the key pair, and put the public key in the application so that we can refer to it at runtime. Run this command to create it and then create an OpenShift <em>Secret</em> that holds the resulting key pair:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mkdir -p $PROJECT_SOURCE/src/main/resources/certs/ &amp;&amp; \
openssl req -subj '/CN={{ROUTE_SUBDOMAIN}}/O=Test Keycloak/C=US' -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out $PROJECT_SOURCE/src/main/resources/certs/certificate.pem &amp;&amp; \
oc -n {{ USER_ID }}-project create secret tls keycloak-cert-secret --cert $PROJECT_SOURCE/src/main/resources/certs/certificate.pem --key key.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>This secret will be used in the next step.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_keycloak_instance"><a class="anchor" href="#_create_keycloak_instance"></a>Create Keycloak instance</h3>
<div class="paragraph">
<p>By creating an instance of a <code>Keycloak</code> object, the Keycloak operator will process it and instantiate a new Keycloak server. In the OpenShift web console, click the <code>Add</code> icon, type <code>keycloak</code> into the search box, click on the "Keycloak" item, and click Create:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/keycloak-create1.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p>On the next screen, make sure you&#8217;re in the <em>YAML view</em>, and replace the YAML with the following definition:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: keycloak
spec:
  instances: 1
  http:
    tlsSecret: keycloak-cert-secret
  hostname:
    hostname: keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}
  db:
    vendor: postgres
    host: keycloak-postgresql
    usernameSecret:
      name: keycloak-postgresql
      key: database-user
    passwordSecret:
      name: keycloak-postgresql
      key: database-password</code></pre>
</div>
</div>
<div class="paragraph">
<p>This references the certificate+key pair created earlier, as well as our Postgres database credentials, which are stored in a secret. Click <strong>Create</strong>, and you will see your new keycloak server starting up:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/keycloak-create2.png" alt="kc" width="500">
</div>
</div>
<div class="paragraph">
<p>Wait for it to complete (and get a dark blue circle). This should only take a few seconds if everything is working! If it does not after a minute or so, double-check that you entered the right values, and the database secret and certificate secret both exist under the names given.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s also visually link Keycloak to its database:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n {{ USER_ID }}-project annotate statefulset keycloak "app.openshift.io/connects-to=keycloak-postgresql" --overwrite</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_log_into_keycloak"><a class="anchor" href="#_log_into_keycloak"></a>Log into Keycloak</h3>
<div class="paragraph">
<p>When you use the keycloak operator, it will generate an initial administrator username/password in a Secret. Access the secret by clicking on <strong>Secrets</strong>, and find the <code>keycloak-initial-admin</code> secret, and click on it:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/keycloak-secrets1.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p>Finally, click on <strong>Reveal Values</strong> to see the username (which should be <code>admin</code>), and the password:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/keycloak-adminsecret.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p><code>admin</code> is pretty easy to remember, but you&#8217;ll probably want to copy the password to your clipboard (using the copy-to-clipboard icon at the far right, or CTRL-C (CMD-C on a Mac)) to use in a moment.</p>
</div>
<div class="paragraph">
<p>Back on the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-project?view=graph[OpenShift web console^] topology page, click the small "open" icon at the upper right of the Keycloak deployment:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/keycloak-openicon.png" alt="kc" width="500">
</div>
</div>
<div class="paragraph">
<p>Log in with the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Username or email</strong>: <code>admin</code></p>
</li>
<li>
<p><strong>Password</strong>: The password you retrieved from the {{ CONSOLE_URL }}/k8s/ns/{{ USER_ID }}-project/secrets/keycloak-initial-admin[secret^] earlier.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/admin-pw.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p>Once logged in, you should be at the Admin home screen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/admin-home.png" alt="kc" width="800">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_import_realm"><a class="anchor" href="#_import_realm"></a>Import Realm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Keycloak <em>realm</em> is a space where you manage objects, including users, applications, roles, and groups. A user belongs to and logs into a realm. One Keycloak deployment can define, store, and manage as many realms as there is space for in the database. Keycloak comes with a <code>master</code> realm but that&#8217;s designed to be used for managing Keycloak itself, not for applications.</p>
</div>
<div class="paragraph">
<p>For authentication purposes, we&#8217;ll import a new realm called <code>globex</code> that has multiple users that we can test our authenticated endpoint code with, as well as a "confidential resource" based on access path, which will enable Keycloak to enforce authorization to this resource without code change.</p>
</div>
<div class="sect2">
<h3 id="_create_a_keycloakrealmimport"><a class="anchor" href="#_create_a_keycloakrealmimport"></a>Create a KeycloakRealmImport</h3>
<div class="paragraph">
<p>The Keycloak operator can import realms you supply by creating an instance of a KeycloakRealmImport object in Kubernetes.</p>
</div>
<div class="paragraph">
<p>We have pre-defined a new realm for this lab, in the <code>inventory/src/main/resources/globex-realm.yaml</code> file. The file contains a definition of the realm, which you can see by opening the file in DevSpaces:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/realm-file.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p>Run the following command to create this object and cause the Keycloak operator to import the realm via a <code>Job</code>:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc apply -n {{ USER_ID }}-project -f $PROJECT_SOURCE/src/main/resources/kc-realm.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see a new <code>Job</code> created, wait for it to complete (for the circle to turn green) and for the Keycloak pod to automatically restart:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/realm-job.png" alt="kc" width="500">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_explore_realm"><a class="anchor" href="#_explore_realm"></a>Explore Realm</h3>
<div class="paragraph">
<p>Go back to the <a href="https://keycloak-{{" class="bare">https://keycloak-{{</a> USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/[Keycloak administration console^] and login as <code>admin</code> user (using the password from the {{ CONSOLE_URL }}/k8s/ns/{{ USER_ID }}-project/secrets/keycloak-initial-admin[Secret^] as before). You should now see a new realm in the Realm dropdown. Select the <code>globex</code> realm by clicking on it.</p>
</div>
<div class="paragraph">
<p>Within the new realm, click on <code>Users</code> to see the pre-created users <code>admin</code>, <code>alice</code>, and <code>jdoe</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/new-users.png" alt="kc" width="800">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>alice</code> is an ordinary user (will have the <code>user</code> role) whose password is <code>alice</code></p>
</li>
<li>
<p><code>admin</code> is an Administrator (has the <code>admin</code> and <code>user</code> role) and their password is <code>admin</code></p>
</li>
<li>
<p><code>jdoe</code> is an ordinary user (has the <code>user</code> role) but has also been granted access to <code>confidential</code> resources in Keycloak, and their password is <code>jdoe</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We have also created a <em>Client</em> within the realm that will be used by our backend inventory service called <code>backend-service</code>. This enables the service itself to authenticate with Keycloak to retrieve realm data.  Click on <strong>Clients</strong> to see this client.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/new-client.png" alt="kc" width="800">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Realm Roles</strong> to see the roles our users are grouped into, <code>admin</code>, <code>confidential</code>, and <code>user</code> (and a few others). For example, clicking on <code>admin</code> &gt; <code>Users in role</code> you can see only Alex Admin is in this role. In the <code>user</code> role, we have all of our fake users.</p>
</div>
<div class="paragraph">
<p>We have also defined a <code>Confidential</code> resource mapping that allows us to use Keycloak&#8217;s fine-grained authorization policies to restrict access to certain endpoints without having to change our application code. We&#8217;ll explore this later!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_jwt_to_quarkus"><a class="anchor" href="#_add_jwt_to_quarkus"></a>Add JWT to Quarkus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like other exercises, we&#8217;ll need another extension to enable the use of MicroProfile JWT. Install it with:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn quarkus:add-extension -Dextensions="smallrye-jwt"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[INFO] [SUCCESS] ✅  Extension io.quarkus:quarkus-smallrye-jwt has been installed</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will add the necessary entries in your <code>pom.xml</code> to bring in JWT support.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_quarkus_for_microprofile_jwt"><a class="anchor" href="#_configure_quarkus_for_microprofile_jwt"></a>Configure Quarkus for MicroProfile JWT</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some configuration of the extension is required. Add this to your <code>application.properties</code>:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">mp.jwt.verify.publickey.location=https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus/protocol/openid-connect/certs<i class="conum" data-value="1"></i><b>(1)</b>
mp.jwt.verify.issuer=https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus<i class="conum" data-value="2"></i><b>(2)</b>
smallrye.jwt.client.tls.certificate.path=classpath:certs/certificate.pem<i class="conum" data-value="3"></i><b>(3)</b>
smallrye.jwt.client.tls.trust-all=true<i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sets public key location for JWT authentication. Keycloak exports this for you at the URL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Issuer URL. This must match the incoming JWT <code>iss</code> <em>claims</em> or else authentication fails.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Since we are using self-signed certificates, we manually supply the self-signed public key certificate used to for TLS certificate validation.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>For simplicity we trust all hosts in this example since we’re using self-signed certs. In practice you would not be using self-signed certs, so proper trust chains can be formed.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_protected_endpoints"><a class="anchor" href="#_create_protected_endpoints"></a>Create protected endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll create 2 protected endpoints. Create a new class file <code>JWTResource.java</code> in the <code>org.acme.people.rest</code> package with the following code:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.people.rest;

import java.security.Principal;
import java.util.Optional;

import jakarta.annotation.security.RolesAllowed;
import jakarta.enterprise.context.RequestScoped;
import jakarta.inject.Inject;
import jakarta.json.JsonString;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.SecurityContext;

import org.eclipse.microprofile.jwt.Claim;
import org.eclipse.microprofile.jwt.Claims;
import org.eclipse.microprofile.jwt.JsonWebToken;

@Path("/secured")
@RequestScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class JWTResource {

    @Inject
    JsonWebToken jwt;  <i class="conum" data-value="2"></i><b>(2)</b>

    @Inject
    @Claim(standard = Claims.iss)
    Optional&lt;JsonString&gt; issuer; <i class="conum" data-value="3"></i><b>(3)</b>

    @GET
    @Path("/me")
    @RolesAllowed("user")
    @Produces(MediaType.TEXT_PLAIN)
    public String me(@Context SecurityContext ctx) {  <i class="conum" data-value="4"></i><b>(4)</b>
        Principal caller = ctx.getUserPrincipal();
        String name = caller == null ? "anonymous" : caller.getName();
        boolean hasJWT = jwt != null;
        return String.format("hello %s, isSecure: %s, authScheme: %s, hasJWT: %s\n", name, ctx.isSecure(), ctx.getAuthenticationScheme(), hasJWT);
    }

    @GET
    @Path("/me/admin")
    @RolesAllowed("admin")
    @Produces(MediaType.TEXT_PLAIN)
    public String meJwt(@Context SecurityContext ctx) {   <i class="conum" data-value="4"></i><b>(4)</b>
        Principal caller = ctx.getUserPrincipal();
        String name = caller == null ? "anonymous" : caller.getName();
        boolean hasJWT = jwt != null;

        final StringBuilder helloReply = new StringBuilder(String.format("hello %s, isSecure: %s, authScheme: %s, hasJWT: %s\n", name, ctx.isSecure(), ctx.getAuthenticationScheme(), hasJWT));
        if (hasJWT &amp;&amp; (jwt.getClaimNames() != null)) {
            helloReply.append("Injected issuer: [" + issuer.get() + "]\n"); <i class="conum" data-value="5"></i><b>(5)</b>
            jwt.getClaimNames().forEach(n -&gt; {
                helloReply.append("\nClaim Name: [" + n + "] Claim Value: [" + jwt.getClaim(n) + "]");
            });
        }
        return helloReply.toString();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adds a <code>@RequestScoped</code> as Quarkus uses a default scoping of <code>ApplicationScoped</code> and this will produce undesirable behavior since JWT claims are naturally request scoped.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>JsonWebToken</code> provides access to the claims associated with the incoming authenticated JWT token.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When using JWT Authentication, claims encoded in tokens can be <code>@Inject</code> ed into your class for convenient access.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>/me</code> and <code>/me/admin</code> endpoints demonstrate how to access the security context for Quarkus apps secured with JWT. Here we are using a <code>@RolesAllowed</code> annotation to make sure that only users granted a specific role can access the endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Use of injected JWT Claim to print the all the claims</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rebuild_and_redeploy_app"><a class="anchor" href="#_rebuild_and_redeploy_app"></a>Rebuild and redeploy app</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s re-build and re-deploy the application:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc delete deployment people &amp;&amp;
mvn clean package -DskipTests &amp;&amp; \
oc label deployment/people app.kubernetes.io/part-of=people --overwrite &amp;&amp; \
oc annotate deployment/people app.openshift.io/connects-to=postgres-database --overwrite</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_confirm_deployment"><a class="anchor" href="#_confirm_deployment"></a>Confirm deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run and wait for the app to complete its rollout:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc rollout status -w deployment/people</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_endpoints"><a class="anchor" href="#_test_endpoints"></a>Test endpoints</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this exercise we are <strong>short-circuiting typical web authentication flows</strong> to illustrate the ease of protecting APIs with Quarkus. In a typical web authentication, users are redirected (via their browser) to a login page, after which a negotiation is performed to retrieve <em>access tokens</em> used on behalf of the user to access protected resources. Here we are doing this manually with <code>curl</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first thing to do to test any endpoint is obtain an access token from your authentication server in order to access the application resources. We&#8217;ve pre-created a few users in Keycloak for you to use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>alice</code> is an ordinary user (will have the <code>user</code> role) whose password is <code>alice</code></p>
</li>
<li>
<p><code>admin</code> is an Administrator (has the <code>admin</code> and <code>user</code> role) and their password is <code>admin</code></p>
</li>
<li>
<p><code>jdoe</code> is an ordinary user (has the <code>user</code> role) but has also been granted access to <code>confidential</code> endpoints in Keycloak, and their password is <code>jdoe</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Try to access the endpoint as an anonymous unauthenticated user:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -i https://$(oc get route people -o=go-template --template={% raw %}'{{ .spec.host }}'{% endraw %})/secured/me</code></pre>
</div>
</div>
<div class="paragraph">
<p>It should fail with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">HTTP/1.1 401 Unauthorized
www-authenticate: Bearer {token}
Content-Length: 0
Set-Cookie: 2a1b392100b8b2cb3705c68f4ecbaf66=1b3560b80b9fad566e105aff1f31f880; path=/; HttpOnly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try with an authenticated user next.</p>
</div>
<div class="sect2">
<h3 id="_test_alice"><a class="anchor" href="#_test_alice"></a>Test Alice</h3>
<div class="paragraph">
<p>Get a token for user <code>alice</code> with this command:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">export ALICE_TOKEN=$(\
    curl -ks -X POST https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus/protocol/openid-connect/token \
    --user backend-service:secret \
    -H 'content-type: application/x-www-form-urlencoded' \
    -d 'username=alice&amp;password=alice&amp;grant_type=password' | jq --raw-output '.access_token' \
 ) &amp;&amp; echo $ALICE_TOKEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>This issues a <code>curl</code> command to Keycloak (using <code>backend-service</code> credentials which is a special user that is allowed acess to the Keycloak REST API), and fetches a token for Alice using their credentials.</p>
</div>
<div class="paragraph">
<p>Try out the JWT-secured API as Alice:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -i https://$(oc get route people -o=go-template --template={% raw %}'{{ .spec.host }}'{% endraw %})/secured/me \
  -H "Authorization: Bearer $ALICE_TOKEN"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">HTTP/1.1 200 OK
Content-Length: 63
Content-Type: text/plain;charset=UTF-8
Set-Cookie: 2a1b392100b8b2cb3705c68f4ecbaf66=1b3560b80b9fad566e105aff1f31f880; path=/; HttpOnly
Cache-control: private

hello alice, isSecure: false, authScheme: Bearer, hasJWT: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now try to access the <code>/me/admin</code> endpoint as <code>alice</code>:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -i https://$(oc get route people -o=go-template --template={% raw %}'{{ .spec.host }}'{% endraw %})/secured/me/admin \
  -H "Authorization: Bearer $ALICE_TOKEN"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">HTTP/1.1 403 Forbidden
Content-Length: 9
Content-Type: text/plain;charset=UTF-8
Set-Cookie: 2a1b392100b8b2cb3705c68f4ecbaf66=1b3560b80b9fad566e105aff1f31f880; path=/; HttpOnly

Forbidden</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alice is not an admin. Let&#8217;s try with admin!</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Access Tokens have a defined lifespan that&#8217;s typically short (e.g. 5 minutes), so if you wait too long, the token will expire and you&#8217;ll get denied access. In this case, just re-fetch a new token using the same <code>curl</code> command used the first time. Full-fledged applications can take advantage of things like <a href="https://oauth.net/2/grant-types/refresh-token/" target="_blank" rel="noopener"><em>Refresh Tokens</em></a> to do this automatically to ensure a good user experience even for slow users.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_test_admin"><a class="anchor" href="#_test_admin"></a>Test Admin</h3>
<div class="paragraph">
<p>Obtain an Admin token:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">export ADMIN_TOKEN=$(\
    curl -ks -X POST https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus/protocol/openid-connect/token \
    --user backend-service:secret \
    -H 'content-type: application/x-www-form-urlencoded' \
    -d 'username=admin&amp;password=admin&amp;grant_type=password' | jq --raw-output '.access_token' \
 ) &amp;&amp; echo $ADMIN_TOKEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>And try again with your new token:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -i https://$(oc get route people -o=go-template --template={% raw %}'{{ .spec.host }}'{% endraw %})/secured/me/admin \
  -H "Authorization: Bearer $ADMIN_TOKEN"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">HTTP/1.1 200 OK
Content-Length: 2256
Content-Type: text/plain;charset=UTF-8
Set-Cookie: 2a1b392100b8b2cb3705c68f4ecbaf66=1b3560b80b9fad566e105aff1f31f880; path=/; HttpOnly
Cache-control: private

hello admin, isSecure: false, authScheme: Bearer, hasJWT: true
Injected issuer: ["https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus"]

Claim Name: [sub] Claim Value: [af134cab-f41c-4675-b141-205f975db679]
Claim Name: [groups] Claim Value: [[admin, user]]
Claim Name: [typ] Claim Value: [Bearer]
Claim Name: [preferred_username] Claim Value: [admin]
... &lt;more claims&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Success! We dump all of the claims from the JWT token for inspection.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_keycloak_authentication"><a class="anchor" href="#_using_keycloak_authentication"></a>Using Keycloak Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Frequently, resource servers only perform authorization decisions based on role-based access control (RBAC), where the roles granted to the user trying to access protected resources are checked against the roles mapped to these same resources. While roles are very useful and used by applications, they also have a few limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resources and roles are tightly coupled and changes to roles (such as adding, removing, or changing an access context) can impact multiple resources</p>
</li>
<li>
<p>Changes to your security requirements can imply deep changes to application code to reflect these changes</p>
</li>
<li>
<p>Depending on your application size, role management might become difficult and error-prone</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keycloak&#8217;s <em>Authorization Services</em> provides fine-grained authorization policies that decouples the authorization policy from your code, so when your policies change, your code doesn&#8217;t have to. In this exercise we&#8217;ll use Keycloak&#8217;s Authorization Services to protect our Quarkus APIs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enable_quarkus_keycloak_and_openid_connect_extensions"><a class="anchor" href="#_enable_quarkus_keycloak_and_openid_connect_extensions"></a>Enable Quarkus Keycloak and OpenID Connect Extensions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, you&#8217;ll need to enable the Keycloak extension by running this command in a Terminal:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn quarkus:add-extension -Dextensions="oidc, keycloak-authorization"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[INFO] [SUCCESS] ✅  Extension io.quarkus:quarkus-oidc has been installed
[INFO] [SUCCESS] ✅  Extension io.quarkus:quarkus-keycloak-authorization has been installed</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_disable_microprofile_jwt_extension"><a class="anchor" href="#_disable_microprofile_jwt_extension"></a>Disable MicroProfile JWT Extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since we will use Keycloak authentication rather than JWT, we&#8217;ll need to disable the JWT extension. To remove the extension, run this command in a Terminal:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn quarkus:remove-extension -Dextensions="smallrye-jwt"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[INFO] [SUCCESS] ✅  Extension io.quarkus:quarkus-smallrye-jwt has been uninstalled</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_keycloak"><a class="anchor" href="#_configuring_keycloak"></a>Configuring Keycloak</h3>
<div class="paragraph">
<p>Next, add these to your <code>application.properties</code> for Keycloak:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none"># OIDC config
quarkus.oidc.auth-server-url=https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus
quarkus.oidc.client-id=backend-service
quarkus.oidc.credentials.secret=secret
quarkus.http.cors=true
quarkus.tls.trust-all=true

# Enable Policy Enforcement
quarkus.keycloak.policy-enforcer.enable=true
quarkus.keycloak.policy-enforcer.paths.ready.name=Readiness
quarkus.keycloak.policy-enforcer.paths.ready.path=/q/health/ready
quarkus.keycloak.policy-enforcer.paths.ready.enforcement-mode=DISABLED
quarkus.keycloak.policy-enforcer.paths.live.name=Liveness
quarkus.keycloak.policy-enforcer.paths.live.path=/q/health/live
quarkus.keycloak.policy-enforcer.paths.live.enforcement-mode=DISABLED</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configures the extension with the necessary configuration ( <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank" rel="noopener">read more</a> about what these do).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We explicitly disable authorization checks for the <code>/health/*</code> endpoints so that the container platform can access them. To support secured health checks, <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">different health check mechanisms</a> like TCP or <code>exec</code> methods can be used.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_create_keycloak_endpoints"><a class="anchor" href="#_create_keycloak_endpoints"></a>Create Keycloak endpoints</h3>
<div class="paragraph">
<p>Create a new class file called <code>KeycloakResource.java</code> in the <code>org.acme.people.rest</code> package with the following code:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.people.rest;

import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

import io.quarkus.security.identity.SecurityIdentity;

@Path("/secured") <i class="conum" data-value="1"></i><b>(1)</b>
public class KeycloakResource {

    @Inject
    SecurityIdentity identity; <i class="conum" data-value="2"></i><b>(2)</b>


    @GET
    @Path("/confidential") <i class="conum" data-value="1"></i><b>(1)</b>
    @Produces(MediaType.TEXT_PLAIN)
    public String confidential() {
        return ("confidential access for: " + identity.getPrincipal().getName() +
          " with attributes:" + identity.getAttributes());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that we do not use any <code>@RolesAllowed</code> or any other instrumentation on the endpoint to specify access policy. It looks like an ordinary endpoint. Keycloak (the server) is the one enforcing access here, not Quarkus directly.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>SecurityIdentity</code> is a generic object produced by the Keycloak extension that you can use to obtain information about the security principals and attributes embedded in the request.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_rebuild_and_redeploy_app_2"><a class="anchor" href="#_rebuild_and_redeploy_app_2"></a>Rebuild and redeploy app</h3>
<div class="paragraph">
<p>Let&#8217;s re-build and re-deploy the application:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn clean package -DskipTests &amp;&amp; \
oc label deployment/people app.kubernetes.io/part-of=people --overwrite &amp;&amp; \
oc annotate deployment/people app.openshift.io/connects-to=postgres-database --overwrite</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_confirm_deployment_2"><a class="anchor" href="#_confirm_deployment_2"></a>Confirm deployment</h3>
<div class="paragraph">
<p>Run and wait for the app to complete its rollout:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc rollout status -w deployment/people</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_confidential"><a class="anchor" href="#_test_confidential"></a>Test confidential</h3>
<div class="paragraph">
<p>The <code>/secured/confidential</code> endpoint is protected with a policy defined in the Keycloak Server. The policy only grants access to the resource if the user is granted with a <code>confidential</code> role. The difference here is that the application is delegating the access decision to Keycloak, so no explicit source code instrumentation is required.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Keycloak caches the resource paths that it is protecting, so that every access doesn&#8217;t cause a roundtrip back to the server to check whether the user is authorized to access the resource. The lifespan of these cached entries can be controlled through <a href="https://www.keycloak.org/docs/latest/authorization_services/index.html#_enforcer_filter" target="_blank" rel="noopener">Policy Enforcer Configuration</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First make sure even <code>admin</code> can&#8217;t access the endpoint:</p>
</div>
<div class="paragraph">
<p>Refresh the admin token (it may have expired):</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">export ADMIN_TOKEN=$(\
    curl -ks -X POST https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus/protocol/openid-connect/token \
    --user backend-service:secret \
    -H 'content-type: application/x-www-form-urlencoded' \
    -d 'username=admin&amp;password=admin&amp;grant_type=password' | jq --raw-output '.access_token' \
 ) &amp;&amp; echo $ADMIN_TOKEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then try to access with it:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -i -X GET \
  https://$(oc get route people -o=go-template --template={% raw %}'{{ .spec.host }}'{% endraw %})/secured/confidential \
  -H "Authorization: Bearer $ADMIN_TOKEN"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see in the returned HTTP headers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">HTTP/1.1 403 Forbidden
content-length: 0
set-cookie: xxxxxxxxxxxx; path=/; HttpOnly</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Failed</code> as expected!</p>
</div>
<div class="paragraph">
<p>To access the confidential endpoint, you should obtain an access token for user <code>jdoe</code>:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">export JDOE_TOKEN=$(\
    curl -ks -X POST https://keycloak-{{ USER_ID }}-project.{{ROUTE_SUBDOMAIN}}/realms/quarkus/protocol/openid-connect/token \
    --user backend-service:secret \
    -H 'content-type: application/x-www-form-urlencoded' \
    -d 'username=jdoe&amp;password=jdoe&amp;grant_type=password' | jq --raw-output '.access_token' \
 ) &amp;&amp; echo $JDOE_TOKEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>And access the confidential endpoint with your new token:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -i -X GET \
  https://$(oc get route people -o=go-template --template={% raw %}'{{ .spec.host }}'{% endraw %})/secured/confidential \
  -H "Authorization: Bearer $JDOE_TOKEN"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">HTTP/1.1 200 OK
content-length: 504
content-type: text/plain;charset=UTF-8
set-cookie: 2a1b392100b8b2cb3705c68f4ecbaf66=2570e701764877eb5f5887a61384aad4; path=/; HttpOnly; Secure; SameSite=None

confidential access for: jdoe with attributes:{configuration-metadata=io.quarkus.oidc.OidcConfigurationMetadata@693a8ad7, io.quarkus.security.identity.AuthenticationRequestContext=io.quarkus.security.runtime.QuarkusIdentityProviderManagerImpl$1@72855e40, io.vertx.ext.web.RoutingContext=io.vertx.ext.web.impl.RoutingContextImpl@4a3f7978, quarkus.identity.expire-time=1717656840, tenant-id=Default, permissions=[Permission {id=99856673-24fa-431b-9e26-93e2113f69db, name=Confidential Resource, scopes=[]}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Success! Even though our code did not explicitly protect the <code>/secured/confidential</code> endpoint, we can protect arbitrary URLs in Quarkus apps when using Keycloak.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_congratulations"><a class="anchor" href="#_congratulations"></a>Congratulations!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This exercise demonstrated how your Quarkus application can use MicroProfile JWT in conjunction with Keycloak to protect your JAX-RS applications using JWT claims and bearer token authorization.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="tracing.html" class="query-params-link">Tracing Quarkus Apps with Jaeger and MicroProfile Tracing</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
