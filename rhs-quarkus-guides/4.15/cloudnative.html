<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cloud Native :: Quarkus Workshop Guides</title>
    <link rel="canonical" href="https://bmeklund.github.io/quarkus-workshop-sandbox/rhs-quarkus-guides/4.15/cloudnative.html">
    <link rel="prev" href="native.html">
    <link rel="next" href="deploy.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://bmeklund.github.io/quarkus-workshop-sandbox">Quarkus Workshop Guides</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhs-quarkus-guides" data-version="4.15">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Quarkus Workshop Guides</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intro.html">Lab Instructions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Module One</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="basics.html">Getting Started with Quarkus</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cdi.html">Dependency Injection</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing.html">Testing Quarkus Apps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="debugging.html">Debugging Quarkus Apps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="native.html">Building Native Quarkus Apps</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="cloudnative.html">Developing Cloud Native with Quarkus</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deploy.html">Deploying to the cloud</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Module Two</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="extensions.html">Using Quarkus extensions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="panache.html">Hibernate ORM with Panache</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="openapi.html">Documenting and Testing APIs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="messaging.html">Event-driven Messaging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="kafka.html">Streaming Data with Quarkus and Kafka</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="monitoring.html">Monitoring with Prometheus and Grafana</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tracing.html">Tracing Quarkus Apps with Jaeger and MicroProfile Tracing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="security.html">Securing Quarkus APIs</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Quarkus Workshop Guides</span>
    <span class="version">4.15</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Quarkus Workshop Guides</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">4.15</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Quarkus Workshop Guides</a></li>
    <li>Module One</li>
    <li><a href="cloudnative.html">Developing Cloud Native with Quarkus</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/bmeklund/quarkus-workshop-sandbox/edit/master/documentation/modules/ROOT/pages/cloudnative.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Cloud Native</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this step we will package the application as a Linux Container image, and deploy it to Kubernetes, and add a few features common to cloud native apps that you as a developer will need to handle. We&#8217;ll use OpenShift 4 as our deployment target, which is a distribution of Kubernetes from Red Hat.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_health_probes"><a class="anchor" href="#_health_probes"></a>Health Probes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus application developers can utilize the MicroProfile Health specification to write HTTP health probes for their applications. These endpoints by default provide basic data about the service however they all provide a way to customize the health data and add more meaningful information (e.g. database connection health, backoffice system availability, etc).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are of course a category of issues that can&#8217;t be resolved by restarting the container. In those scenarios, the container never recovers and traffic will no longer be sent to it (which can have cascading effects on the rest of the system, possibly requiring human intervention, which is why monitoring is crucial to availability).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_add_extension"><a class="anchor" href="#_add_extension"></a>Add Extension</h3>
<div class="paragraph">
<p>Let&#8217;s build a simple REST application endpoint exposes <a href="https://microprofile.io" target="_blank" rel="noopener">MicroProfile</a> Health checks at the <code>/health</code> endpoint according to the specification. It will also provide several other REST endpoints to allow us to dynamically query the health of our Quarkus application.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll need to add a <a href="https://quarkus.io/extensions" target="_blank" rel="noopener">Quarkus Extension</a> to enable this feature in our app. Fortunately, adding a Quarkus extension is super easy. We&#8217;ll cover extensions in more depth in other sections of this workshop but for now, open a Terminal and execute the following command to add the extension to our project&#8217;s <code>pom.xml</code>:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn quarkus:add-extension -Dextensions="smallrye-health"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[INFO] [SUCCESS] ✅  Extension io.quarkus:quarkus-smallrye-health has been installed</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will add the extension below to your <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-smallrye-health&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you go back to Dev UI, you will see a new <code>SmallRye Health</code> extension:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quarkus-devui-health.png" alt="native" width="800">
</div>
</div>
<div class="paragraph">
<p>With no code, Quarkus still provides a default health check which may be enough for you if all you need is to know the app started. Try to access the <code>/health/ready</code> endpoint on the Terminal:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/q/health/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This default health check will return success as long as the app is running - if it crashes, the health check will of course fail.</p>
</div>
</div>
<div class="sect2">
<h3 id="_add_a_probe"><a class="anchor" href="#_add_a_probe"></a>Add a probe</h3>
<div class="paragraph">
<p>We can now implement a <em>better</em> Health Check using the MicroProfile APIs. Create a new Java class - <code>org.acme.people.health.SimpleHealthCheck</code> (hint: right-click on the <code>org.acme.people.health</code> package and select <em>New &gt; File</em> and name it <code>SimpleHealthCheck.java</code>). In this file, implement the health check (you can copy/paste this code):</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.people.health;

import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.HealthCheckResponse;
import org.eclipse.microprofile.health.Readiness;

import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
@Readiness
public class SimpleHealthCheck implements HealthCheck {

    @Override
    public HealthCheckResponse call() {
        return HealthCheckResponse.named("Simple health check").up().build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see health check procedures are defined as implementations of the <code>HealthCheck</code> interface which are defined as CDI beans with the either the <code>@Readiness</code> or <code>@Liveness</code> annotation. <code>HealthCheck</code> is a functional interface whose single method <code>call</code> returns a <code>HealthCheckResponse</code> object which can be easily constructed by the fluent builder API shown above. This simple example will serve as our <em>Readiness</em> probe.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are two types of probes in Quarkus apps (and Kubernetes):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Liveness Probe - Many applications running for long periods of time eventually transition to broken states, and cannot recover except by being restarted. Kubernetes provides liveness probes to detect and remedy such situations. Restarting a container in such a state can help to make the application more available despite bugs.</p>
</li>
<li>
<p>Readiness Probe - Sometimes, applications are temporarily unable to serve traffic. For example, an application might need to load large data or configuration files during startup, or depend on external services after startup. In such cases, you don’t want to kill the application, but you don’t want to send it requests either. Kubernetes provides readiness probes to detect and mitigate these situations. A pod with containers reporting that they are not ready does not receive traffic through Kubernetes Services.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Readiness and liveness probes can be used in parallel for the same container. Using both can ensure that traffic does not reach a container that is not ready for it, and that containers are restarted when they fail. There are various <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/" target="_blank" rel="noopener">Configuration Paramters</a> you can set, such as the timeout period, frequency, and other parameters that can be tuned to expected application behavior.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Thanks to Live Coding mode, simply open a Terminal window and run:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/q/health/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new health check procedure is now present in the <code>checks</code> array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "Simple health check",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations! You’ve created your first Quarkus health check procedure. Let’s continue by exploring what else can be done with the MicroProfile Health specification.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_data_in_health_checks"><a class="anchor" href="#_custom_data_in_health_checks"></a>Custom data in health checks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous step we created a simple health check with only the minimal attributes, namely, the health check name and its state (<code>UP</code> or <code>DOWN</code>). However, MicroProfile also provides a way for the applications to supply arbitrary data in the form of key/value pairs sent in the health check response. This can be done by using the <code>withData(key, value)`</code> method of the health check response builder API. This is useful to provide additional info about passing or failing health checks, to give some indication of the problem when failures are investigated.</p>
</div>
<div class="paragraph">
<p>Let’s create our second health check procedure, a <em>Liveness</em> probe. Create another Java class file in the <code>org.acme.people.health</code> package named <code>DataHealthCheck.java</code> with the following code:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.people.health;

import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.HealthCheckResponse;
import org.eclipse.microprofile.health.Liveness;

import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
@Liveness
public class DataHealthCheck implements HealthCheck {

    @Override
    public HealthCheckResponse call() {
        return HealthCheckResponse.named("Health check with data")
        .up()
        .withData("foo", "fooValue")
        .withData("bar", "barValue")
        .build();

    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Access the liveness health checks:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/q/health/live</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the new health check with data is present in the <code>checks</code> array. This check contains a new attribute called <code>data</code> which is a JSON object consisting of the properties (e.g. <code>bar=barValue</code>) we have defined in our health check procedure above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">{
    "status": "UP",
    "checks": [
        {
            "name": "Health check with data",
            "status": "UP",
            "data": {
                "foo": "fooValue",
                "bar": "barValue"
            }
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_negative_health_checks"><a class="anchor" href="#_negative_health_checks"></a>Negative Health Checks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we create another health check which simulates a connection to an external service provider such as a database. For simplicity reasons, we&#8217;ll use an <code>application.properties</code> setting to toggle the health check from <code>DOWN</code> to <code>UP</code>.</p>
</div>
<div class="paragraph">
<p>Create another Java class in the same package called <code>DatabaseConnectionHealthCheck.java</code> with the following code:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.people.health;

import org.eclipse.microprofile.config.inject.ConfigProperty;
import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.HealthCheckResponse;
import org.eclipse.microprofile.health.HealthCheckResponseBuilder;
import org.eclipse.microprofile.health.Liveness;

import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
@Liveness
public class DatabaseConnectionHealthCheck implements HealthCheck {

    @ConfigProperty(name = "database.up", defaultValue = "false")
    public boolean databaseUp;

    @Override
    public HealthCheckResponse call() {

        HealthCheckResponseBuilder responseBuilder = HealthCheckResponse.named("Database connection health check");

        try {
            simulateDatabaseConnectionVerification();
            responseBuilder.up();
        } catch (IllegalStateException e) {
            // cannot access the database
            responseBuilder.down()
                    .withData("error", e.getMessage());
        }

        return responseBuilder.build();
    }

    private void simulateDatabaseConnectionVerification() {
        if (!databaseUp) {
            throw new IllegalStateException("Cannot contact database");
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Re-run the health check test:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -i http://localhost:8080/q/health/live</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see at the beginning the HTTP response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">HTTP/1.1 503 Service Unavailable</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the returned content should begin with <code>"status": "DOWN"</code> and you should see in the <code>checks</code> array the newly added Database connection health check which is down and the error message explaining why it failed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">        {
            "name": "Database connection health check",
            "status": "DOWN",
            "data": {
                "error": "Cannot contact database"
            }
        },</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fix_health_check"><a class="anchor" href="#_fix_health_check"></a>Fix Health Check</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We shouldn’t leave this application with a health check in DOWN state. Because we are running Quarkus dev mode, add this to to the end of the <code>src/main/resources/application.properties</code> file:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">database.up=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>And access again using the same <code>curl</code> command — it should be <code>UP</code>!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_accessing_liveness_and_readiness_separately"><a class="anchor" href="#_accessing_liveness_and_readiness_separately"></a>Accessing liveness and readiness separately</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus apps can access the two different types using two different endpoints (<code>/health/live</code> and <code>/health/ready</code>). This is useful when configuring Kubernetes with probes which we&#8217;ll do later, as it can access each separately (and configure each with different timeouts, periods, failure thresholds, etc). For example, You may want your Readiness probe to wait 30 seconds before starting, but Liveness should wait 2 minutes and only wait 10 seconds between retries.</p>
</div>
<div class="paragraph">
<p>Access the two endpoints. Each endpoint will only report on its specific type of probe:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/q/health/live</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should only see the two Liveness probes.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/q/health/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should only see our single readiness probes.</p>
</div>
<div class="paragraph">
<p>Go back to Dev UI and select <code>Health UI</code> in SmallRye Health extension:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quarkus-devui-healthui.png" alt="livecoding" width="700">
</div>
</div>
<div class="paragraph">
<p>It shows all health checks:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quarkus-devui-healthui2.png" alt="livecoding" width="700">
</div>
</div>
<div class="paragraph">
<p>Later, when we deploy this to our Kubernetes cluster, we&#8217;ll configure it to use these endpoints.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_externalized_configuration"><a class="anchor" href="#_externalized_configuration"></a>Externalized Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hardcoded values in your code are a no-no (even if we all did it at some point ;-)). In this step, we learn how to configure your application to externalize configuration.</p>
</div>
<div class="paragraph">
<p>Quarkus uses <a href="https://microprofile.io/project/eclipse/microprofile-config" target="_blank" rel="noopener">MicroProfile Config</a> to inject the configuration into the application. The injection uses the <code>@ConfigProperty</code> annotation, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ConfigProperty(name = "greeting.message")
String message;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When injecting a configured value, you can use <code>@Inject @ConfigProperty</code> or just <code>@ConfigProperty</code>. The <code>@Inject</code> annotation is not necessary for members annotated with <code>@ConfigProperty</code>, a behavior which differs from <a href="https://microprofile.io/project/eclipse/microprofile-config" target="_blank" rel="noopener">MicroProfile Config</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_add_some_external_config"><a class="anchor" href="#_add_some_external_config"></a>Add some external config</h3>
<div class="paragraph">
<p>In the <code>org.acme.people.rest.GreetingResource</code> class, add the following fields to the class definition below the existing <code>@Inject GreetingService service;</code> line:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @ConfigProperty(name = "greeting.message")
    String message;

    @ConfigProperty(name = "greeting.suffix", defaultValue="!")
    String suffix;

    @ConfigProperty(name = "greeting.name")
    Optional&lt;String&gt; name;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll get red squiggly errors underneath <code>@ConfigProperty</code>. Hover the cursor over them and select <em>Quick Fix</em>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quickfix.png" alt="quickfix" width="600">
</div>
</div>
<div class="paragraph">
<p>and select <code>Import 'ConfigProperty' (org.eclipse.microprofile.config.inject)</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quickfiximport.png" alt="quickfix" width="600">
</div>
</div>
<div class="paragraph">
<p>Do the same for the <code>java.util.Optional</code> type to eliminate the errors.</p>
</div>
<div class="paragraph">
<p>The new <code>import</code> statements can also be added manually:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.config.inject.ConfigProperty;
import java.util.Optional;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>MicroProfile config annotations include a <code>name =</code> (required) and a <code>defaultValue =</code> (optional). You can also later access these values directly if declared as a String or other primitive type, or declare them with <code>&lt;Optional&gt;</code> type to safely access them using the <em>Optional</em> API in case they are not defined.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, modify the <code>hello()</code> method to use the injected properties:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @GET
    @Produces(MediaType.TEXT_PLAIN)
    @NonBlocking
    public String hello() {
        return message + " " + name.orElse("world") + suffix;
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we use the <em>Optional</em> API to safely access the value using <code>name.orElse()</code> and provide a default <code>world</code> value in case the value for <code>name</code> is not defined in <code>application.properties</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_create_the_configuration"><a class="anchor" href="#_create_the_configuration"></a>Create the configuration</h3>
<div class="paragraph">
<p>By default, Quarkus reads <code>application.properties</code>. Add the following properties to the <code>src/main/resources/application.properties</code> file:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">greeting.message=hello
greeting.name=quarkus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open up a Terminal window and run a <code>curl</code> command to test the changes:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get <code>hello quarkus!</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the application requires configuration values and these values are not set, an error is thrown. So you can quickly know when your configuration is complete.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Quarkus Dev UI also allows you to edit the configuration values then the change is automatically updated in your local file system (e.g., <em>application.properties</em>).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go to the Dev UI, then select <code>Configuration</code> on the left menu. Key <code>greeting</code> in the search box then it will show <strong>greeting.message</strong> property. Then update the value to <code>hi</code> then select <code>Disk</code> icon:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quarkus-devui-configeditor.png" alt="quarkus-devui-configeditor" width="700">
</div>
</div>
<div class="paragraph">
<p>Then, you will see the <strong>Property greeting.message updated</strong>. Make sure if the <em>application.properties</em> file is updated automatically:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quarkus-devui-configeditor-update2.png" alt="quarkus-devui-configeditor" width="700">
</div>
</div>
<div class="paragraph">
<p>Re-run a <code>curl</code> command to test the changes:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get <code>hi quarkus!</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_update_the_test"><a class="anchor" href="#_update_the_test"></a>Update the test</h3>
<div class="paragraph">
<p>We also need to update the functional test to reflect the changes made to endpoint. Edit the <code>src/test/java/org/acme/people/GreetingResourceTest.java</code> file and change the content of the <code>testHelloEndpoint</code> method to:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Test
    public void testHelloEndpoint() {
        given()
          .when().get("/hello")
          .then()
            .statusCode(200)
            .body(is("hi quarkus!")); // Modified line
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since our application is still running from before, thanks to Quarkus Live Reload we should immediately see changes. Update <code>application.properties</code>, by changing the <code>greeting.message</code>, <code>greeting.name</code>, or adding <code>greeting.suffix</code> and running the same <code>curl <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a></code> after each change.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quarkus_configuration_options"><a class="anchor" href="#_quarkus_configuration_options"></a>Quarkus Configuration options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus itself is configured via the same mechanism as your application. Quarkus reserves the <code>quarkus.</code> namespace in <code>application.properties</code> for its own configuration.</p>
</div>
<div class="paragraph">
<p>You can find the <a href="https://quarkus.io/guides/all-config" target="_blank" rel="noopener">All configuration options</a> here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/all-config.png" alt="all-config" width="700">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Overriding properties at runtime</strong></p>
</div>
<div class="paragraph">
<p>As you have seen, in <em>dev</em> mode, properties can be changed at will and reflected in the running app, however once you are ready to package your app for deployment, you&#8217;ll not be running in <em>dev</em> mode anymore, but rather building and packaging (e.g. into fat JAR or native executable.) Quarkus will do much of its configuration and bootstrap at build time. Most properties will then be read and set during the <em>build time</em> step. To change them, you have to stop the application, re-package it, and restart.</p>
</div>
<div class="paragraph">
<p>Extensions <em>do</em> define some properties as overridable at runtime. A canonical example is the database URL, username and password which is only known specifically in your target environment. <strong>This is a tradeoff</strong> as the more runtime properties are available, the less build time pre-work Quarkus can do. The list of runtime properties is therefore lean.</p>
</div>
<div class="paragraph">
<p>You can override these runtime properties with the following mechanisms (in decreasing priority):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using system properties:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>for a runner jar: <code>java -Dquarkus.datasource.password=youshallnotpass -jar target/myapp-runner.jar</code></p>
</li>
<li>
<p>for a native executable: <code>./target/myapp-runner -Dquarkus.datasource.password=youshallnotpass</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>using environment variables:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>for a runner jar: <code>QUARKUS_DATASOURCE_PASSWORD=youshallnotpass java -jar target/myapp-runner.jar</code></p>
</li>
<li>
<p>for a native executable: <code>QUARKUS_DATASOURCE_PASSWORD=youshallnotpass ./target/myapp-runner</code></p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Environment variables names are following the conversion rules of <a href="https://github.com/eclipse/microprofile-config/blob/master/spec/src/main/asciidoc/configsources.asciidoc#default-configsources" target="_blank" rel="noopener">Eclipse MicroProfile Config sources</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_configuration_profiles"><a class="anchor" href="#_configuration_profiles"></a>Configuration Profiles</h3>
<div class="paragraph">
<p>Quarkus supports the notion of configuration <em>profiles</em>. These allow you to have multiple configuration values in <code>application.properties</code> and select between then via a profile name.</p>
</div>
<div class="paragraph">
<p>The syntax for this is <code>%{profile}.config.key=value</code>. For example if I have the following: (do not copy this code!):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">quarkus.http.port=9090
%dev.quarkus.http.port=8181</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Quarkus HTTP port will be <code>9090</code>, unless the <code>dev</code> profile is active, in which case it will be <code>8181</code>.</p>
</div>
<div class="paragraph">
<p>By default Quarkus has three profiles, although it is possible to use as many as you like (just use your custom profile names in <code>application.properties</code> and when running the app, and things will match up). The default profiles are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>dev</code> - Activated when in development mode (i.e. <code>mvn quarkus:dev</code>)</p>
</li>
<li>
<p><code>test</code> - Activated when running tests (i.e. <code>mvn verify</code>)</p>
</li>
<li>
<p><code>prod</code> - The default profile when not running in <code>dev</code> or <code>test</code> mode</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_configuration_profile"><a class="anchor" href="#_exercise_configuration_profile"></a>Exercise Configuration Profile</h3>
<div class="paragraph">
<p>Let&#8217;s give this a go. In your <code>application.properties</code>, add a different <code>message.prefix</code> for the <code>prod</code> profile. To do this, change the content of the <code>greeting.</code> properties in <code>application.properties</code> to be:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">greeting.message=hi
greeting.name=quarkus in dev mode
%prod.greeting.name=production quarkus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that in <em>dev</em> mode (which you&#8217;re currently running in) that:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8080/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>produces <code>hi quarkus in dev mode!</code>.</p>
</div>
<div class="paragraph">
<p>Next, let&#8217;s re-build the app as an executable JAR (which will run with the <code>prod</code> profile active).</p>
</div>
<div class="paragraph">
<p>Build an executable JAR using the <strong>Package app for OpenShift</strong> task to build a fast-jar:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cmd-package.png" alt="livecoding" width="700">
</div>
</div>
<div class="paragraph">
<p>Next, select <strong>devfile: 05. Run Fast Jar</strong> task:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/run-fastjar.png" alt="livecoding" width="700">
</div>
</div>
<div class="paragraph">
<p>Notice we did not specify any Quarkus profile. When not running in dev mode (<code>mvn quarkus:dev</code>), and not running in test mode (<code>mvn verify</code>), then the default profile is <code>prod</code>.</p>
</div>
<div class="paragraph">
<p>While the app is running, open a separate Terminal window and test it by running:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl http://localhost:8081/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>What did you get? You should get <code>hi production quarkus!</code> indicating that the <code>prod</code> profile was active by default. In other sections in this workshop we&#8217;ll use this feature to override important variables like database credentials.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this example we read configuration properties from <code>application.properties</code>. You can also introduce custom configuration sources in the standard MicroProfile Config manner.  <a href="https://microprofile.io/project/eclipse/microprofile-config" target="_blank" rel="noopener">More Info</a>. This would be useful, for example, to read directly from <strong>Kubernetes ConfigMap</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cleanup"><a class="anchor" href="#_cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Stop the app that you ran with <code>java -jar</code> by pressing <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> in the terminal in which the app runs. Make sure to leave the original Live Coding app running!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_congratulations"><a class="anchor" href="#_congratulations"></a>Congratulations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cloud native encompasses much more than health probes and externalized config. With Quarkus' <em>container and Kubernetes-first philosophy</em>, excellent performance, support for many cloud native frameworks, it&#8217;s a great place to build your next cloud native app.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="native.html" class="query-params-link">Building Native Quarkus Apps</a></span>
  <span class="next"><a href="deploy.html" class="query-params-link">Deploying to the cloud</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
